- name : Define txtcollection filename and folder
  set_fact:
    txtcollection_file: "txtcol_{{ file_suffix }}.tar.gz"
    txtcollection_folder: "{{ output_folder }}/txtcollect"

- name: "Check if {{ txtcollection_folder }}/{{ txtcollection_file }} exists"
  stat:
    path: "{{ txtcollection_folder }}/{{ txtcollection_file }}"
  register: txtcollection_stat_result

# Will skip all the rest if the txtcollection file does not exists
- block:

  - include: tasks/local_sqlplus.yml
    vars:
      sql_param : { task_action : "Create sqlldr table" ,
                    cred : "{{ oci_adb_connection_tns }}" ,
                    file : "create_sqlldr_txtcollection_table.sql" ,
                    folder : "user_scripts/odbfcl/adb_load_txtcollection_files" ,
                    params : ""
                  }

  - name: "Load {{ txtcollection_file }} in the database"
    shell: |
        set -e

        v_file="{{ txtcollection_file }}"
        v_outpref="{{ shared_folder }}/{{ txtcollection_file }}"

        rm -rf "${v_outpref}_unzip"
        mkdir "${v_outpref}_unzip"

        tar -tvf "{{ txtcollection_folder }}/${v_file}" | grep -o '\./.*' > "${v_outpref}_unzip/${v_file}_files.txt"

        tar -xf "{{ txtcollection_folder }}/${v_file}" -C "${v_outpref}_unzip"

        cat << EOF > "${v_outpref}_load.ctl"
        LOAD
        INTO TABLE T_TXTCOLLECTION_LOAD
        APPEND
        FIELDS TERMINATED BY ','
        (file_name constant "${v_file}",
         path,
         contents lobfile(path) terminated by eof)
        EOF

        cd "${v_outpref}_unzip"

        sqlldr {{ oci_adb_connection_tns }} \
        control="${v_outpref}_load.ctl" \
        errors=0 \
        discardmax=0 \
        direct=Y \
        data="${v_file}_files.txt" \
        log="${v_outpref}_load.log"

        rm -f "${v_outpref}_load.log" "${v_outpref}_load.ctl"
        rm -rf "${v_outpref}_unzip"

    register: sqloutput

  - name: SQL Output
    debug: msg="{{ sqloutput.stdout_lines }}"

  - include: tasks/local_sqlplus.yml
    vars:
      sql_param : { task_action : "Load txtcollection table" ,
                    cred : "{{ oci_adb_connection_tns }}" ,
                    file : "load_txtcollection_table.sql" ,
                    folder : "user_scripts/odbfcl/adb_load_txtcollection_files" ,
                    params : ""
                  }

  when: txtcollection_stat_result.stat.exists