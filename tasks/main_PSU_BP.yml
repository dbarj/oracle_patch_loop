### Will Run PSU + OJVM + BP for given version

- name : Define version
  set_fact:
    patch_file:    "{{ item.main_file }}"
    patch_list:    "{{ item.patch_list }}"
    opatch_file:   "{{ item.opatch_file }}"
  with_items: "{{ list_versions }}"
  when: item.id == db_version

- name : Define VBox params
  set_fact:
    vm_machine:    "{{ item.vmachine }}"
    vm_ip_address: "{{ item.ip }}"
    patch_base:    "{{ item.base_snap }}"
  with_items: "{{ list_info_vbox }}"
  when: item.id == db_version and not oci_mode

- name : Define Cloud params
  set_fact:
    oci_instance_id: "{{ item.oci_instance_id }}"
    patch_base:    "{{ item.base_snap }}"
  with_items: "{{ list_info_oci }}"
  when: item.id == db_version and oci_mode

# This parameter will control if database start command was ever called.
- name : Define database_started variable to false.
  set_fact:
    database_started: false

### For PSU or OJVM
- block:

  # Define base_OJVM_line. This is used by patch_task_post to save the snapshot.
  - name: Get latest PSU ID
    set_fact:
      latest_PSU_id: "{{ lookup('vars', patch_list) | json_query(filter_qry_1) | max }}"
      base_OJVM_id: "{{ ( ( lookup('vars', patch_list) | json_query(filter_qry_2) ) + [0] ) | max }}"
    vars:
      filter_qry_1: "[? type == 'PSU' ].id"
      filter_qry_2: "[? type == 'PSU' && base_ojvm != null ].id"

  - name : Set base OJVM ID
    set_fact:
      base_OJVM_id: "{{ latest_PSU_id }}"
    when: (base_OJVM_id | int) == 0

  - name : Generate base_OJVM_line
    set_fact:
      base_OJVM_line: "{{ db_version }}|PSU|{{ base_OJVM_id }}"

  - name: "Base OJVM"
    debug: msg="Base OJVM ID - {{ base_OJVM_line }}"

  when: param_type is undefined or param_type == "PSU" or param_type == "OJVM"

### PSU
- block:

  - name : Define snapshot base version to rollback when reload is called.
    set_fact:
      vm_snapshot: "{{ patch_base }}"

  # Execute for base release
  - include: "{{ patch_file }}"
    vars:
      patch : { type : BASE , id : 0, patch_number : 0 }
    when:
      - 0 == (param_patch | float)      or param_patch == -1
      - 0 >= (param_patch_from | float) or param_patch_from == -1
      - 0 <= (param_patch_to | float)   or param_patch_to == -1

  # Execute for every PSU
  - include: "{{ patch_file }}"
    loop: "{{ lookup('vars', patch_list) | flatten(levels=1) }}"
    loop_control:
      loop_var: patch
      label: "{{ patch.id }}"
    when:
      - patch.type == "PSU"
      - patch.id == (param_patch | float)      or param_patch == -1
      - patch.id >= (param_patch_from | float) or param_patch_from == -1
      - patch.id <= (param_patch_to | float)   or param_patch_to == -1

  when: param_type is undefined or param_type == "PSU"

### OJVM
- block:

  ### Clean OJVM dumps if base_OJVM_id is different from the last.
  - include: clean_ojvm_dumps.yml base_id="PSU_{{ base_OJVM_id }}"

  - name : Change Base Snapshot Name - VBox Mode
    set_fact:
      vm_snapshot: "{{ db_version }} PSU {{ base_OJVM_id }}"
    when: not oci_mode

  - name : Change Base Snapshot Name - LVM Mode
    set_fact:
      vm_snapshot: "PSU_{{ base_OJVM_id }}"
    when: oci_mode

  - name: "Base Snapshot will be {{ vm_snapshot }}"
    debug: msg="Base Snapshot will be {{ vm_snapshot }}"

  # Execute for every OJVM
  - include: "{{ patch_file }}"
    loop: "{{ lookup('vars', patch_list) | flatten(levels=1) }}"
    loop_control:
      loop_var: patch
      label: "{{ patch.id }}"
    when:
      - patch.type == "OJVM"
      - patch.id == (param_patch | float)      or param_patch == -1
      - patch.id >= (param_patch_from | float) or param_patch_from == -1
      - patch.id <= (param_patch_to | float)   or param_patch_to == -1

  when: param_type is undefined or param_type == "OJVM"

### BP
- block:

  - name : Define snapshot base version to rollback when reload is called.
    set_fact:
      vm_snapshot: "{{ patch_base }}"

  # Execute for every BP
  - include: "{{ patch_file }}"
    loop: "{{ lookup('vars', patch_list) | flatten(levels=1) }}"
    loop_control:
      loop_var: patch
      label: "{{ patch.id }}"
    when:
      - patch.type == "BP"
      - patch.id == (param_patch | float)      or param_patch == -1
      - patch.id >= (param_patch_from | float) or param_patch_from == -1
      - patch.id <= (param_patch_to | float)   or param_patch_to == -1

  when: param_type is undefined or param_type == "BP"

# Stop OCI VM
- name: Call role to stop OCI VM
  include_role:
    name: oci_compute_instance_actions
  vars:
    compute_action: stop
  when: oci_mode and not only_deploy_patch and database_started